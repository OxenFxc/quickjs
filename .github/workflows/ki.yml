name: ci

on:
  pull_request:
    paths:
      - '**'
      - '!.gitignore'
      - '!LICENSE'
      - '!TODO'
      - '!doc/**'
      - '!examples/**'
      - '.github/workflows/ci.yml'
  push:
    branches:
      - '*'

jobs:
  linux:
    name: Linux (Ubuntu)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Build
        run: |
          make -j$(getconf _NPROCESSORS_ONLN) CONFIG_WERROR=y
      - name: Stats
        run: |
          ./qjs -qd
      - name: Run built-in tests
        run: |
          make test
      - name: Run microbench
        run: |
          make microbench
      - name: Run test262
        run: |
          make test2-bootstrap
          make test2

  linux-lto:
    name: Linux LTO
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Build
        run: |
          make -j$(getconf _NPROCESSORS_ONLN) CONFIG_WERROR=y CONFIG_LTO=y
      - name: Run built-in tests
        run: |
          make test
      - name: Run microbench
        run: |
          make microbench

  android:
    name: Android QJS C Core
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        abi: [arm64-v8a, armeabi-v7a]  # 安卓主流架构
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: 安装安卓 SDK/NDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 24
          ndk-version: 25.2.9519653
          build-tools-version: 34.0.0
      - name: 编译安卓 QJS C 核心库（动态库）
        run: |
          export ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653
          export TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
          # 架构适配
          if [ "${{ matrix.abi }}" = "arm64-v8a" ]; then
            TARGET=aarch64-linux-android24
          else
            TARGET=armv7a-linux-androideabi24
          fi
          # 编译 libquickjs.so（安卓动态库，含 QJS C 核心）
          make -j$(getconf _NPROCESSORS_ONLN) \
            CC=$TOOLCHAIN/bin/$TARGET-clang \
            AR=$TOOLCHAIN/bin/llvm-ar \
            LD=$TOOLCHAIN/bin/$TARGET-clang \
            CFLAGS="-fPIC -D_GNU_SOURCE -DCONFIG_JSBIGINT" \
            LDFLAGS="-shared -llog -landroid -lm" \
            libquickjs.so
      - name: 上传安卓 QJS C 核心库
        uses: actions/upload-artifact@v4
        with:
          name: quickjs-android-core-${{ matrix.abi }}
          path: libquickjs.so
